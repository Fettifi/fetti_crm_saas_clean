import subprocess\nimport textwrap\nimport datetime as _dt\nfrom pathlib import Path\nimport sys\nimport json\n\nPROJECT_ROOT = Path(__file__).resolve().parent\n\n\ndef header():\n    print("\n" + "=" * 40)\n    print("   <0001doc>  Fetti Doctor – CRM Helper")\n    print("=" * 40)\n    print(\n        textwrap.dedent(\n            """\n            - Runs a multi-step health check for this repo:\n                1) npm run lint\n                2) npm test (only if defined in package.json)\n                3) npm run build\n            - Designed to be called with --auto by Fetti Wizard / Wrapper.\n            """\n        ).strip()\n    )\n    print("\n")\n\n\ndef run_step(name, cmd):\n    now = _dt.datetime.now().strftime("%Y-%m-%d %H:%M:%S")\n    print("\n" + "=" * 60)\n    print(f"[{now}] FETTI DOCTOR – Step: {name}")\n    print("=" * 60)\n    print(f"[FETTI DOCTOR] $ {' '.join(cmd)}\n")\n\n    proc = subprocess.run(cmd, cwd=PROJECT_ROOT, text=True)\n    code = proc.returncode\n    if code == 0:\n        print(f"\n[FETTI DOCTOR] Step '{name}' ✅ (exit code 0)")\n    else:\n        print(f"\n[FETTI DOCTOR] Step '{name}' ❌ (exit code {code})")\n    return code\n\n\ndef get_steps():\n    steps = [("Lint", ["npm", "run", "lint"])]\n\n    pkg_path = PROJECT_ROOT / "package.json"\n    try:\n        pkg = json.loads(pkg_path.read_text())\n        scripts = pkg.get("scripts", {})\n        if "test" in scripts:\n            steps.append(("Test", ["npm", "test"]))\n    except Exception:\n        pass\n\n    steps.append(("Build", ["npm", "run", "build"]))\n    return steps\n\n\ndef main():\n    header()\n\n    steps = get_steps()\n    failed_step = None\n    failed_code = 0\n\n    for name, cmd in steps:\n        code = run_step(name, cmd)\n        if code != 0:\n            failed_step = name\n            failed_code = code\n            break\n\n    if failed_step is None:\n        print("\n[FETTI DOCTOR] All steps passed. ✅")\n# Auto-deploy hook: optional Git + Vercel push\nimport os as _os_autodeploy, subprocess as _sub_autodeploy\nif _os_autodeploy.environ.get("FETTI_AUTO_DEPLOY") == "1":\n    print("\n[FETTI DOCTOR] Auto-deploy enabled – running `npm run fetti:deploy`...")\n    try:\n        _sub_autodeploy.run(["npm", "run", "fetti:deploy"], check=True)\n        print("[FETTI DOCTOR] Auto-deploy completed successfully.")\n    except _sub_autodeploy.CalledProcessError as e:\n        print(f"[FETTI DOCTOR] Auto-deploy failed with code {e.returncode}.")\n\n        print("[FETTI DOCTOR] Lint / Test (if any) / Build all succeeded with no critical issues.\n")\n        sys.exit(0)\n    else:\n        print(\n            print("\n[FETTI DOCTOR] Health check failed. ❌")\n            f"with exit code {failed_code}. ❌"\n        )\n        sys.exit(failed_code)\n\n\nif __name__ == "__main__":\n    main()\n